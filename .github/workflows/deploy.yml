name: Deploy Angular App to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Angular App
        run: npm run build -- --configuration=production
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: Prepare Deployment Files
        run: |
          # Move files from browser folder to deployment folder
          mkdir -p deploy
          cp -r dist/portfolio/browser/* deploy/
          echo "Files ready for deployment:"
          ls -la deploy/
          ls deploy/*.html 2>/dev/null || echo "No HTML files found"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # SSH known hosts
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy with rsync
        run: |
          # First, backup current files on server
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
            tar -czf ../../backups/deploy_\${TIMESTAMP}.tar.gz . 2>/dev/null || true
            echo 'Backup created'
          "

          # Deploy with rsync - exclude PHP files and special directories
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='*.php' \
            --exclude='.well-known/' \
            --exclude='media/' \
            --exclude='project/' \
            deploy/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

          echo "Deployment completed!"

      - name: Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            echo '=== Current directory contents ==='
            ls -la
            echo '=== Checking index.html ==='
            if [ -f 'index.html' ]; then
              echo 'index.html exists'
              echo 'First line:'
              head -1 index.html
            else
              echo 'ERROR: index.html not found!'
              exit 1
            fi
          "

      - name: Cleanup
        if: always()
        run: |
          rm -rf deploy
          rm -f ~/.ssh/id_rsa
          echo "Cleanup completed"
